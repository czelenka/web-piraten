# WebPiraten

Webpiraten is a web environment to gain inside a programming language (for example for pupils). The user can move a pirate ship controlled by a programming language over a grid. The ship interacts with objects on the grid, which allows a lot of tasks for the user. For example one task could be to collect all treasures on the grid.

Webpiraten is the result of a bachelor project at the University of Kiel. The names in the code and the comments are in English, but the user interface is in German.

WebPiraten supports Ruby, Erlang and Java as programming languages. But it is easy to include a new one (see below).

Its recommended to use the production branch, because the master branch is used for development.

![Screenshot](/app/assets/images/help/start.png)

## Structure

There are two main components:

* The rails web server which provides the wep page with the grid, the editor and the control elements.
* The vm script which runs the code produced by the user.

## Installation

### Rails webserver

The web server uses the ruby version stored in *.ruby-version*. In order to get the web server working install this version (for example by using [rvm](https://rvm.io/rvm/install)).

The important config file is *config/initializers/application.conf.rb*. This file specifies:

* The ip and port of the vm: The web server will connect here to execute user code.
* The execution timeout: The user code will be stopped after this time.
* The prefix: Because the vm script uses stdin and stdout to communicate with the programming language, which allows a simple implementation of new programming languages, the prefix makes sure that outputs generated by the user can be distinguished from outputs to control the ship.
* The pepper: The pepper makes sure that commands sent to the vm script are from the web server. Otherwise everyone could send commands to the vm script. Specify the path to a file which contains the pepper (a random string). The pepper is only needed for production mode.

Beside this change the secret token in *config/initializers/secret_token.rb* for use in production mode.

### Execution VM

The vm script uses the same ruby version as the web server but can also (most likely) use a newer one. The path to the vm script is *vm/vm/vm.rb*. This script is an interface between the web server and the programming language. It communicates via tcp with the web server and via stdio with the programming language.

Because the code executed by the programming language is written by the user and is thus potentially dangerous, the vm script (in production mode) should run in a secured environment, for example a prepared virtual machine.

Below an exemplary description of a VM running the vm script:

1. Start with a new instance of a simple linux distribution (for example debian-linux without GUI)
2. Add four users:
    * *sailor* (without home dir): A user to run the potential dangerous code (with read-only permissions).
    * *builder* (without home dir): A user to compile the potential dangerous code (write permissions in code directories).
    * *captain*: A user to save the user code to a file and to compile the code (write permissions in some directories).
    * *navigator*: A user to configure the VM (root permissions).
3. Install sudo (if not installed) and edit to sudo file `[visudo]`:
    * allow *captain* to execute as *sailor* and as *builder* without password: `[captain ALL = (sailor) NOPASSWD: ALL]*, *[captain ALL = (builder) NOPASSWD: ALL]`
    * allow *navigator* to execute as *root*: `[navigator ALL = (ALL) NOPASSWD: ALL]`
4. Create a folder for the user code (for example `/codetemp`).
5. Edit `/etc/fstab`:
    * Mount `/` read-only (This means you cannot edit anything after a reboot. Use `mount -o remount,rw /` to allow write permission temporary until reboot.). You could even better disallow write access from outside (in the VM settings on the host system).
    * Mount `/codetemp` from RAM: `[tmpfs /codetemp tmpfs defaults,size=50% 0 0]`
    * Disable `/tmp` (because the permissions are automatically set to `drwxrwxrwt`, which allows write access to *sailor*) `[none /tmp tmpfs ro]`. Be aware that some programmes (like `cron` or `visudo`) did not work without `/tmp`.
6. Disallow *sailor* and *builder* to use the network connection. You could run `iptables -A OUTPUT -m owner --uid-owner sailor -j DROP` and `iptables -A OUTPUT -m owner --uid-owner builder -j DROP` on every start or even better disallow the network access from outside. (But make sure that the web server can connect to the vm script.)
7. Install the programming languages of you choice, which are supported by the web server (install ruby in any case).
8. Copy necessary files to the vm:
    * The vm script `vm/vm/vm.rb` and the config file `vm/vm/vm.conf.rb` (for example into `/home/captain/vm`).
    * The pepper from above (for example into `/pepper`).
    * Additional libraries for the supported programming languages. The source is stored in `vm/src`. In the java source `vm/src/java/logic/Ship.java` you have to edit the prefix like above. Compile the source (java: `mkdir -p vm/vm/lib/java &&  javac -d vm/vm/lib/java vm/src/java/logic/\*.java` - erlang: `mkdir -p vm/vm/lib/erlang && erlc -o vm/vm/lib/erlang vm/src/erlang/\*.erl`) and copy it into the VM (for example into `/home/captain/vm/lib`).
9. Set permissions:
    * Disallow *sailor* and *builder* to read `/pepper`, but allow *captain* to do so.
    * Allow *sailor* and *builder* to read the additional libraries `[/home/captain/vm/lib]`.
    * Disallow *sailor* and *captain* to read `/home/captain/vm.rb` and `/home/captain/vm.conf.rb`.
    * Disallow *sailor* to write in `/codetemp`, but allow *sailor* to read it. Allow *captain* and *builder* to read and write `/codetemp`. The vm script creates a subfolder in `/codetemp` for every execution. Make sure that *captain* and *builder* are allowed to write into the subfolder. For example you could set the owner to *captain* and the group to *builder* and set the setgid-bit `[chown captain:builder /codetemp; chmod 2775 /codetemp]`. It can happen that the permissions get lost on a reboot (because the folder is mounted from ram), so set the permissions after every reboot.
10. Edit `/home/captain/vm/vm.conf.rb`:
    * Set the prefix and the timeout as above.
    * Set the maximal operation a user program should be allowed to do.
    * Set the port on which the script should wait for a command from the web server.
    * Set the path to `/codetemp`.
    * Set the path to the additional libraries relative from the running dir of the vm script.
    * Set the name of the user which should execute the code *(sailor)*.
    * Set the name of the user which should compile the code *(builder)*.
    * Set the path to `/pepper`.
    * Set the list of IPs which are allowed to connect to the vm script (the server IP).
11. Run the vm script with parameter `production` as user *captain* `[su -c 'ruby -C /home/captain/vm vm.rb production' captain]`.

In development mode the vm script can run without this security settings on your one computer. This means there is no need for the pepper, the whitelist and the VM. The vm script will be started by the web server in development mode (set environment variable WITHOUT_VM to start the vm script manually). But make sure that you install the additional programming languages on your computer and compile the additional libraries.

## Adding a new programming language

To add a new programming language follow the steps below:

* Create a new preprocessor in `app/controllers/preprocessor`. You will find a template in `app/controllers/preprocessor/template/example_preprocessor.rb`. You could also have a look into the Java preprocessor, which is the most basic one. As you want to provide more features (like line highlighting or tracing variables), this becomes more complex.
* Modify the config in `config/initializers/load_language`.
* Implement the logic for the new language. An easy example is the implementation of the ruby logic (method `insert_logic` in `app/controllers/preprocessor/ruby/ruby_preprocessor.rb`).